# Methods

To generate synthetic populations for each Public Use Microdata Area (PUMA) 
contained within the Mystic River Watershed area, we used a combination of 
coding languages (R version 4.2.2 (2022-10-31) and Fortran) and a combination of datasets used to generate 
PUMA-specific constraint tables. Note that the geographic resolution used for these
methods is the census tract level. 

```{r methods-image,echo=FALSE,out.width=700,fig.cap="Using PUMA and ACS to Generate a Synthetic Population"}
setwd("~/Desktop/SUMMER2023/ResearchRotation/github_acres/synthpop-bookdown/")
 knitr::include_graphics("images/methods-image.png")
```


Obtaining the datasets required: 

1. Creating lists of census tracts located in each of the 10 PUMAs using R
2. Pulling ACS census tract data for each of the 10 PUMA sets of census tracts using R
3. Pulling the Public Use Microdata Samples for each PUMA, including person and household variables

The datasets are then cleaned: 

1. ACS dataset are cleaned and combined in R (with separate runs for each PUMA)
2. PUMS data is cleaned and combined in R (with separate runs for each PUMA) 

N.B. (1) and (2) above generate output textfiles which can then be read into and implemented in the CO model, which is written in Fortran.

Update a few additional tables: 

1. Constraining tables information textfile. This file is also an output file with parameters used to reflect different ancestry bins by PUMA (NOTE: FJBI still confused by this).
2. Control parameters file with PUMA name, number of constraint cells for that PUMA, and row below (number of constraint cells x 10).

Run with CO_BU, the executable created by compiling Fortran code.  

Read the resulting output from the CO work using R. 


## Geographic area 

There are 21 cities and towns included in the Mystic River Watershed area: 

1. Burlington 
2. Lexington 
3. Belmont 
4. Watertown 
5. Arlington 
6. Winchester 
7. Woburn 
8. Reading 
9. Stoneham 
10. Medford 
11. Somerville 
12. Cambridge 
13. Boston (East Boston, Charlestown) 
14. Everett 
15. Malden 
16. Melrose 
17. Wakefield 
18. Chelsea 
19. Revere 
20. Winthrop 
21. Wilmington 


## ACS constraint tables 

ACS 5-year (2021) detailed estimates tables for Massachusetts census tracts were obtained. 

### Race/Ethnicity 

  - B04006 [People Reporting Ancestry](https://data.census.gov/table?q=B0400&g=040XX00US25&tid=ACSDT1Y2021.B04006) 
    - Collapsed by town/city: all ancestry groups with more than 1% of the population represented are retained, those with less than 1% are collapsed to 'other'
  - B03001 [Hispanic or Latino by Specific Origin](https://data.census.gov/table?q=B03001&g=040XX00US25,25$1400000) 
  
  Note that ACS 5-year (2021) detailed estimates tables include People Reporting Single Ancestry, People Reporting Multiple Ancestry, and a combined table of both - People Reporting Ancestry (B04006, used here). In order to approximate the first-ancestry reported, as this is the ancestry included in the PUMS (see section below), we did some re-weighting of the B04006 table variables. In brief, this method was as follows:   
  
  For a given PUMA (Public Use Microdata Area) in the set of 10 included PUMAs, and for each census tract within that PUMA, we re-weight all ancestry variables by proceeding across columns.   
  
  If true total $= total_{true}$ and total with multiple ancestries $= total_{obs}$, and observed population in a given ancestry column for that row $= Z_{obs}$, then the re-weighted $Z_{rw}$ is   
  
  $$
  Z_{rw} = \frac{Z}{\frac{total_{true}}{total_{obs}}}
  $$
  To round to whole units of persons, we use a probabilistic coin-toss methodology:   
  
  Let the probability of rounding up be $mod(Z_{rw},1)$.  
  
  Using the 'set.seed()' function in R, generate a random number, $P$, between 0 and 1.   
  
  Then, the rounded number is:  
  
  $$
  Z_{rw-integer} = Z_{rw}-mod(Z_{rw},1)+P.
  $$
  This is helpful, except when the new total, $total_{new}$ no longer equals $total_{true}$.To amend this, we apply a 'fudge factor': 
  Rank all ancestry columns based on $Z_{rw_integer}$. Based on the difference between $total_{true}$ and $total_{new}$, we adjust the data as needed:   
  
  If $total_{new}-total_{true} = 0$, then do nothing.   
  
  If $total_{new}-total_{true} = total_{diff} > 0$, remove 1 from each of the top $n = total_{diff}$ ranked ancestries.   
  If $total_{new}-total_{true} = total_{diff} < 0$, add 1 to each of the top $n = total_{diff}$ ranked ancestries.  
  
  We keep ancestry variables where the proportion of the PUMA of that background equals or exceeds 1%. This means different ancestry variables were included for different PUMAs. The following table provides the list of included ancestries by PUMA. 
  
```{r nice-tab0, echo=FALSE, tidy=FALSE}
library(readxl)
ancestrytable <- read_excel("PUMA_ancestries_variable_lists.xlsx", sheet = "overall")
knitr::kable(ancestrytable, caption = 'B04006 and B03001 Variables by PUMA',booktabs = TRUE)
```
  
### Sex and Age 

  - B01001 [Sex by Age](https://data.census.gov/table?q=B01001&g=040XX00US25,25$1400000) 
  
```{r nice-tab1, echo=FALSE, tidy=FALSE}
library(readxl)
B01001 <- read_excel("acs_variables.xlsx", sheet = "B01001")
knitr::kable(B01001, caption = 'B01001 Variables',booktabs = TRUE)
```
  
### Education 

  - B15001 [Sex by educational attainment for the population 18 years and over](https://data.census.gov/table?q=B15001&g=040XX00US25,25$1400000) 
  
```{r nice-tab2, echo=FALSE, tidy=FALSE}
B15001 <- read_excel("acs_variables.xlsx", sheet = "B15001")
knitr::kable(B15001, caption = 'B15001 Variables',booktabs = TRUE)
```

### Householder Age and Household Income 

  - B19307 [Age of householder by household income in the past 12 months (2021 inflation-adjusted dollars)](https://data.census.gov/table?q=B19037&g=040XX00US25,25$1400000) 
  
### Householder Age and Tenure 

  - B25007 [Tenure by Age of Householder](https://data.census.gov/table?q=B25007&g=040XX00US25,25$1400000) 
  



## PUMS data 

ACS 5-year (2017-2021) Public Use Microdata Sample (PUMS) files for *person* data and for *household* data. These data sample approximately 5% of individual responses to the ACS. Full documentation on this data is provided in the [PUMS User Guide](https://www2.census.gov/programs-surveys/acs/tech_docs/pums/2017_2021ACS_PUMS_User_Guide.pdf).

We have downloaded the PUMS data at the highest spatial resolution available: PUMA (Public Use Microdata Area), geographic units developed in the Decennial Census (here, 2010) of approximately 100,000 people per PUMA. 

```{r nice-tab3, echo=FALSE, tidy=FALSE}
library(readr)
person <- read_csv("PUMA_p_variables.csv")
hhold <- read_csv("PUMA_h_variables.csv")
knitr::kable(person, caption = 'Relevant PUMS Person Variables', booktabs = TRUE)
knitr::kable(hhold, caption = 'Relevant PUMS Household Variables', booktabs = TRUE)
```

## Bring into the CO model

### Phase 1: with replacement

This we will do for basic demographics, the 13 characteristics as before

### Phase 2: without replacement

This we will do once we have the housing data Jon shared

## Exporting from the CO model

